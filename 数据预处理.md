# 医学影像数据预处理步骤

#### 1. 数据格式转换
- DICOM到NIfTI转换
- 其他格式转换（如JPEG, PNG）

#### 2. 数据清洗
- 去除无效数据
- 填补缺失数据

#### 3. 图像重采样
- 空间分辨率统一
- 像素间距标准化

#### 4. 图像配准
- 同一患者多模态图像对齐
- 跨患者图像对齐

#### 5. 图像裁剪和重尺寸
- ROI（Region of Interest）提取
- 统一图像尺寸

#### 6. 图像归一化和标准化
- 灰度值归一化（0-1之间）
- 标准化到标准分布（减去均值除以标准差）

#### 7. 去噪和增强
- 去噪
  - 高斯滤波
  - 中值滤波
- 数据增强
  - 旋转、平移、缩放
  - 翻转、裁剪
  - 亮度、对比度调整

#### 8. 直方图均衡化
- 提高对比度
- 增强图像细节

#### 9. 边界增强
- 拉普拉斯滤波
- Canny边缘检测

#### 10. 伪影去除
- MRI和CT伪影去除
- 特殊伪影处理

#### 11. HU值标准化（CT图像特有）
- **将CT图像的HU值转换到一个常见范围（例如-1000到400）**

#### 12. 分割前的预处理
- 切片选择
- 标注信息处理


## 1.读取DICOM文件并转换为NIfTI


    import pydicom
    import nibabel as nib
    import numpy as np
    import os
    
    def dicom_to_nifti(dicom_folder, output_file):
        slices = [pydicom.dcmread(os.path.join(dicom_folder, f)) for f in os.listdir(dicom_folder)]
        slices.sort(key=lambda x: int(x.InstanceNumber))
        image_3d = np.stack([s.pixel_array for s in slices])
        affine = np.eye(4)
        nifti_img = nib.Nifti1Image(image_3d, affine)
        nib.save(nifti_img, output_file)

## 图像归一化

    def normalize_image(image):
        image = image.astype(np.float32)
        image /= np.max(image)
        return image
## 2. 数据清洗-去除无效数据

    def remove_invalid_data(images, labels):
        valid_images = []
        valid_labels = []
        for img, lbl in zip(images, labels):
            if np.sum(lbl) > 0:  # assuming valid data has non-zero labels
                valid_images.append(img)
                valid_labels.append(lbl)
        return valid_images, valid_labels

## 3. 图像重采样-空间分辨率统一
    import SimpleITK as sitk
    
    def resample_image(image, new_spacing=[1.0, 1.0, 1.0]):
        spacing = image.GetSpacing()
        size = image.GetSize()
    
        new_size = [int(round(size[i] * (spacing[i] / new_spacing[i]))) for i in range(3)]
        resample = sitk.ResampleImageFilter()
        resample.SetOutputSpacing(new_spacing)
        resample.SetSize(new_size)
        resample.SetOutputDirection(image.GetDirection())
        resample.SetOutputOrigin(image.GetOrigin())
        resample.SetInterpolator(sitk.sitkLinear)
        return resample.Execute(image)
## 4. 图像配准-同一患者多模态图像对齐
    def register_images(fixed_image, moving_image):
        initial_transform = sitk.CenteredTransformInitializer(fixed_image, 
                                                              moving_image, 
                                                              sitk.Euler3DTransform(), 
                                                              sitk.CenteredTransformInitializerFilter.GEOMETRY)
        registration_method = sitk.ImageRegistrationMethod()
        registration_method.SetMetricAsMeanSquares()
        registration_method.SetOptimizerAsRegularStepGradientDescent(1.0, .01, 200)
        registration_method.SetInitialTransform(initial_transform, inPlace=False)
        registration_method.SetInterpolator(sitk.sitkLinear)
        final_transform = registration_method.Execute(fixed_image, moving_image)
        return sitk.Resample(moving_image, fixed_image, final_transform, sitk.sitkLinear, 0.0, moving_image.GetPixelID())
## 5. 图像裁剪和重尺寸-ROI（Region of Interest）提取
    
    def crop_image(image, roi):
        return image[roi[0]:roi[1], roi[2]:roi[3], roi[4]:roi[5]]

## 6. 图像归一化和标准化-灰度值归一化（0-1之间）

    def normalize_image(image):
        image = image.astype(np.float32)
        image /= np.max(image)
        return image
    标准化到标准分布（减去均值除以标准差
    def standardize_image(image):
        mean = np.mean(image)
        std = np.std(image)
        return (image - mean) / std
## 7. 去噪和增强-高斯滤波
    from scipy.ndimage import gaussian_filter
    
    def denoise_image(image, sigma=1):
        return gaussian_filter(image, sigma=sigma)
    数据增强
    from imgaug import augmenters as iaa

    def augment_image(image):
        seq = iaa.Sequential([
            iaa.Fliplr(0.5),  # 水平翻转
            iaa.Affine(rotate=(-20, 20))  # 旋转
        ])
        return seq.augment_image(image)
## 8. 直方图均衡化-提高对比度
    import cv2
    
    def equalize_histogram(image):
        return cv2.equalizeHist(image)
## 9. 边界增强-拉普拉斯滤波
    def laplacian_filter(image):
        return cv2.Laplacian(image, cv2.CV_64F)
## 10. 伪影去除-MRI和CT伪影去除-有待完善
## 11. HU值标准化（CT图像特有） [HU详情可参考：](https://blog.csdn.net/weixin_47244593/article/details/131421465)
   
    def hu_window(image, min_hu, max_hu):
        image = np.clip(image, min_hu, max_hu)
        image = (image - min_hu) / (max_hu - min_hu)
        return image
